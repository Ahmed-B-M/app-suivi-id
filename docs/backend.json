
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user profile with their role.",
      "properties": {
        "uid": { "type": "string" },
        "email": { "type": "string", "format": "email" },
        "role": { "type": "string", "enum": ["admin", "RD", "Dispatch", "RH", "Qualité"] },
        "displayName": { "type": "string" }
      },
      "required": ["uid", "email", "role"]
    },
    "Tache": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Tache",
      "type": "object",
      "description": "Représente une tâche filtrée de l'API Urbantz avec des champs en français.",
      "properties": {
        "tacheId": { "type": "string" },
        "type": { "type": "string" },
        "date": { "type": "string", "format": "date-time" },
        "progression": { "type": "string" },
        "client": { "type": "string" },
        "nomPlateforme": { "type": "string" },
        "dateCreation": { "type": "string", "format": "date-time" },
        "dateCloture": { "type": "string", "format": "date-time" },
        "dateMiseAJour": { "type": "string", "format": "date-time" },
        "tentatives": { "type": "number" },
        "completePar": { "type": "string" },
        "nomHub": { "type": "string" },
        "nomTournee": { "type": "string" },
        "sequence": { "type": "number" },
        "nomAssocie": { "type": "string" },
        "livreur": {
          "type": "object",
          "properties": {
            "prenom": { "type": "string" },
            "nom": { "type": "string" },
            "idExterne": { "type": "string" }
          }
        },
        "creneauHoraire": {
          "type": "object",
          "properties": {
            "debut": { "type": "string", "format": "date-time" },
            "fin": { "type": "string", "format": "date-time" }
          }
        },
        "heureReelle": {
          "type": "object",
          "properties": {
            "arrivee": {
              "type": "object",
              "properties": {
                "date": { "type": "string", "format": "date-time" },
                "adresseCorrecte": { "type": "boolean" }
              }
            }
          }
        },
        "tempsDeServiceReel": {
          "type": "object",
          "properties": {
            "debut": { "type": "string", "format": "date-time" },
            "fin": { "type": "string", "format": "date-time" },
            "duree": { "type": "number" }
          }
        },
        "tempsDeServiceEstime": { "type": "number" },
        "contact": {
          "type": "object",
          "properties": {
            "personne": { "type": "string" },
            "telephone": { "type": "string" },
            "email": { "type": "string" },
            "infoImmeuble": {
              "type": "object",
              "properties": {
                "etage": { "type": ["string", "number"] },
                "ascenseur": { "type": "boolean" },
                "digicode1": { "type": "string" },
                "interphone": { "type": "boolean" },
                "codeInterphone": { "type": "string" }
              }
            }
          }
        },
        "localisation": {
          "type": "object",
          "properties": {
            "adresse": { "type": "string" },
            "rue": { "type": "string" },
            "numero": { "type": "string" },
            "codePostal": { "type": "string" },
            "ville": { "type": "string" },
            "codePays": { "type": "string" },
            "geometrie": { "type": "array", "items": { "type": "number" } }
          }
        },
        "instructions": { "type": "string" },
        "dimensions": {
          "type": "object",
          "properties": {
            "volume": { "type": "number" },
            "bac": { "type": "string" },
            "poids": { "type": "number" }
          }
        },
        "articles": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "nom": { "type": "string" },
              "statut": { "type": "string" },
              "codeBarre": { "type": "string" },
              "type": { "type": "string" },
              "dimensions": {
                "type": "object",
                "properties": {
                  "poids": { "type": "number" }
                }
              },
              "log": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "date": { "type": "string", "format": "date-time" },
                    "vers": { "type": "string" }
                  }
                }
              }
            }
          }
        },
        "execution": {
          "type": "object",
          "properties": {
            "sansContact": {
              "type": "object",
              "properties": {
                "forced": { "type": "boolean" }
              }
            }
          }
        },
        "metaDonnees": {
          "type": "object",
          "properties": {
            "notationLivreur": { "type": "number" },
            "commentaireLivreur": { "type": "string" },
            "immeuble": { "type": "string" }
          }
        }
      },
      "required": ["tacheId"]
    },
    "Tournee": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Tournee",
      "type": "object",
      "description": "Représente une tournée épurée de l'API Urbantz avec des champs personnalisés.",
      "properties": {
        "id": { "type": "string" },
        "date": { "type": "string", "format": "date-time" },
        "dimensions": {
          "type": "object",
          "properties": {
            "poids": { "type": "number" },
            "bac": { "type": "number" },
            "volume": { "type": "number" }
          }
        },
        "endLocation": { "type": "string" },
        "endTime": { "type": "string", "format": "date-time" },
        "labelsAndSkills": { "type": "array" },
        "metadata": {
          "type": "object",
          "properties": {
            "codePostalMaitre": { "type": "string" },
            "TempsDepassementPlanifie": { "type": "number" },
            "TempSURG_Chargement": { "type": "string" },
            "TempsFRAIS_Chargement": { "type": "string" },
            "Immatriculation": { "type": "string" },
            "TempsFRAIS_Fin": { "type": "string" },
            "TempsSURG_Fin": { "type": "string" }
          }
        },
        "name": { "type": "string" },
        "orderCount": { "type": "number" },
        "realInfo": {
          "type": "object",
          "properties": {
            "hasPrepared": { "type": "string", "format": "date-time" },
            "hasStarted": { "type": "string", "format": "date-time" },
            "hasFinished": { "type": ["string", "null"], "format": "date-time" },
            "preparationTime": { "type": "number" },
            "hasLasted": { "type": ["number", "null"] }
          }
        },
        "reloads": { "type": "array" },
        "senders": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "count": { "type": "number" }
            }
          }
        },
        "startLocation": { "type": "string" },
        "startTime": { "type": "string", "format": "date-time" },
        "status": { "type": "string" },
        "stops": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
                "coordinates": { "type": "array", "items": { "type": "number" } },
                "taskId": { "type": "string" },
                "progress": { "type": "string" },
                "status": { "type": "string" },
                "sequence": { "type": "number" },
                "stopSequence": { "type": "number" },
                "travelDistance": { "type": "number" },
                "arriveTime": { "type": "string", "format": "date-time" },
                "departTime": { "type": "string", "format": "date-time" },
                "travelTime": { "type": "number" },
                "serviceTime": { "type": "number" },
                "waitTime": { "type": "number" },
                "violationTime": { "type": "number" },
                "closureDate": { "type": ["string", "null"], "format": "date-time" }
            }
          }
        },
        "totalDistance": { "type": "number" },
        "totalOrderServiceTime": { "type": "number" },
        "totalTime": { "type": "number" },
        "totalTravelTime": { "type": "number" },
        "totalViolationTime": { "type": "number" },
        "totalWaitTime": { "type": "number" },
        "updated": { "type": "string", "format": "date-time" },
        "validated": { "type": "boolean" },
        "driver": {
          "type": "object",
          "properties": {
            "externalId": { "type": "string" },
            "firstName": { "type": "string" },
            "lastName": { "type": "string" }
          }
        },
        "delay": {
          "type": "object",
          "properties": {
            "time": { "type": "number" },
            "when": { "type": "string", "format": "date-time" }
          }
        },
        "orderDone": { "type": "number" },
        "vehicle": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "dimensions": {
                "type": "object",
                "properties": {
                    "poids": { "type": "number" },
                    "bac": { "type": "number" },
                    "volume": { "type": "number" }
                }
            },
            "accelerationTime": { "type": "number" },
            "maxOrders": { "type": "number" },
            "maxDistance": { "type": "number" },
            "maxDuration": { "type": "number" },
            "fixedCost": { "type": "number" },
            "costPerUnitTime": { "type": "number" },
            "costPerUnitDistance": { "type": "number" },
            "type": { "type": "string" },
            "reloading": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "time": { "type": "number" }
              }
            },
            "breaks": { "type": "boolean" },
            "labels": { "type": "array" }
          }
        }
      },
      "required": ["id"]
    },
    "Round": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Round",
      "type": "object",
      "description": "Represents a round fetched from the Urbantz API.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the round."
        },
        "name": {
          "type": "string",
          "description": "Name of the round."
        },
        "status": {
          "type": "string",
          "description": "Status of the round."
        },
        "date": {
          "type": "string",
          "format": "date-time",
          "description": "Date of the round."
        }
      },
      "required": [
        "id",
        "name",
        "status",
        "date"
      ]
    },
     "CategorizedComment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CategorizedComment",
      "type": "object",
      "description": "Represents a customer comment that has been categorized by AI or manually.",
      "properties": {
        "taskId": { "type": "string" },
        "comment": { "type": "string" },
        "rating": { "type": "number" },
        "category": { "type": "array", "items": { "type": "string" } },
        "taskDate": { "type": "string", "format": "date-time" },
        "driverName": { "type": "string" },
        "status": { "type": "string", "enum": ["à traiter", "en cours", "traité"] }
      },
      "required": ["taskId", "comment", "rating", "category", "taskDate", "status"]
    },
    "NpsData": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "NpsData",
        "type": "object",
        "description": "Représente une analyse NPS sauvegardée, associée à une date.",
        "properties": {
            "associationDate": { "type": "string", "format": "date-time" },
            "verbatims": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "taskId": { "type": "string" },
                        "npsScore": { "type": "number" },
                        "npsCategory": { "type": "string", "enum": ["Promoter", "Passive", "Detractor"] },
                        "verbatim": { "type": "string" },
                        "store": { "type": "string" },
                        "taskDate": { "type": "string", "format": "date-time" },
                        "carrier": { "type": "string" },
                        "depot": { "type": "string" },
                        "driver": { "type": "string" }
                    },
                    "required": ["taskId", "npsScore", "npsCategory", "verbatim"]
                }
            }
        },
        "required": ["associationDate", "verbatims"]
    },
    "ProcessedNpsVerbatim": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ProcessedNpsVerbatim",
      "type": "object",
      "description": "Represents a detractor's verbatim that has been processed with responsibility and category.",
      "properties": {
        "taskId": { "type": "string", "description": "The original task ID, used as the document ID." },
        "npsScore": { "type": "number" },
        "verbatim": { "type": "string" },
        "responsibilities": { "type": "array", "items": { "type": "string" } },
        "category": { "type": "array", "items": { "type": "string" } },
        "status": { "type": "string", "enum": ["à traiter", "en cours", "traité"] },
        "store": { "type": "string" },
        "taskDate": { "type": "string", "format": "date-time" },
        "carrier": { "type": "string" },
        "depot": { "type": "string" },
        "driver": { "type": "string" }
      },
      "required": ["taskId", "npsScore", "verbatim", "status"]
    },
    "ActionNoteDepot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ActionNoteDepot",
      "type": "object",
      "description": "Represents a daily note or action plan related to driver feedback for a specific depot.",
      "properties": {
        "depot": { "type": "string", "description": "The name of the depot." },
        "date": { "type": "string", "format": "date", "description": "The date of the note in YYYY-MM-DD format." },
        "content": { "type": "string", "description": "The content of the note." }
      },
      "required": ["depot", "date", "content"]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "type": "object",
      "description": "Represents a system-generated alert or notification.",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["quality_alert", "overweight_round", "late_delivery_pattern"]
        },
        "message": { "type": "string" },
        "status": {
          "type": "string",
          "enum": ["unread", "read", "archived"]
        },
        "createdAt": { "type": "string", "format": "date-time" },
        "relatedEntity": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["task", "round", "driver"] },
            "id": { "type": "string" }
          },
          "required": ["type", "id"]
        }
      },
      "required": ["type", "message", "status", "createdAt"]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information, including their role.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user (from Firebase Auth)."
            }
          ]
        }
      },
      {
        "path": "/tasks/{taskId}",
        "definition": {
          "entityName": "Tache",
          "schema": {
            "$ref": "#/backend/entities/Tache"
          },
          "description": "Stores task data fetched from the Urbantz API. Includes `hubId` and `customerId` to reference related entities.",
          "params": [
            {
              "name": "taskId",
              "description": "Unique identifier for the task."
            }
          ]
        }
      },
      {
        "path": "/rounds/{roundId}",
        "definition": {
          "entityName": "Tournee",
          "schema": {
            "$ref": "#/backend/entities/Tournee"
          },
          "description": "Stores round data fetched from the Urbantz API.",
          "params": [
            {
              "name": "roundId",
              "description": "Unique identifier for the round."
            }
          ]
        }
      },
      {
        "path": "/categorized_comments/{taskId}",
        "definition": {
          "entityName": "CategorizedComment",
          "schema": { "$ref": "#/backend/entities/CategorizedComment" },
          "description": "Stores categorized customer comments. The document ID is the same as the task ID to ensure uniqueness.",
          "params": [
            {
              "name": "taskId",
              "description": "The unique identifier for the task this comment belongs to."
            }
          ]
        }
      },
      {
        "path": "/nps_data/{date}",
        "definition": {
          "entityName": "NpsData",
          "schema": { "$ref": "#/backend/entities/NpsData" },
          "description": "Stores NPS analysis results for a specific date. The document ID is the date in 'YYYY-MM-DD' format.",
          "params": [
            {
              "name": "date",
              "description": "The date of the NPS analysis batch."
            }
          ]
        }
      },
       {
        "path": "/processed_nps_verbatims/{taskId}",
        "definition": {
          "entityName": "ProcessedNpsVerbatim",
          "schema": { "$ref": "#/backend/entities/ProcessedNpsVerbatim" },
          "description": "Stores processed NPS detractor verbatims. The document ID is the task ID to ensure uniqueness.",
          "params": [
            {
              "name": "taskId",
              "description": "The unique identifier for the task this verbatim belongs to."
            }
          ]
        }
      },
      {
        "path": "/action_notes_depot/{depotDateId}",
        "definition": {
          "entityName": "ActionNoteDepot",
          "schema": { "$ref": "#/backend/entities/ActionNoteDepot" },
          "description": "Stores daily action notes for a specific depot. The document ID is a composite of `depot-date`.",
          "params": [
            {
              "name": "depotDateId",
              "description": "The unique identifier for the note, e.g., 'Aix-2024-08-01'."
            }
          ]
        }
      },
      {
        "path": "/notifications/{notificationId}",
        "definition": {
          "entityName": "Notification",
          "schema": { "$ref": "#/backend/entities/Notification" },
          "description": "Stores system-generated notifications and alerts.",
          "params": [
            {
              "name": "notificationId",
              "description": "The unique ID for the notification."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to store data fetched from the Urbantz API, focusing on Tasks and Rounds. A top-level collection for each entity is used. This design prioritizes simplicity for data retrieval and avoids nested collections, which simplifies querying and rule creation.\n\nAuthorization Independence is achieved because there is no authorization specified on this data. If authorization was needed, for example, if some tasks are private to certain users. The `tasks` collection would need to include denormalized authorization data (like a `members` map or `ownerId`) to avoid `get()` calls in security rules.\n\nQAPs (Rules are not Filters): The flat structure of each collection ensures secure list operations. Security rules can be applied to each collection based on the properties within the documents, without requiring filtering based on parent document data."
  }
}
